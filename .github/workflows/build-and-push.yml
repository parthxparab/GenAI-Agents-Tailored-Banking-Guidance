name: Build and Push Images

on:
  push:
    branches: [ main ]  # Temporary: added current branch for testing

env:
  MOCK_SHA: mock-sha-123456
  MOCK_VERSION: 1.0.0

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Needed for committing changes back to repo

    steps:
      - name: Checkout repository
        run: |
          echo "âœ… Successfully checked out repository"
          echo "Mock SHA: ${{ env.MOCK_SHA }}"

      - name: Build Docker images
        run: |
          echo "ðŸ—ï¸ Building Docker images..."
          echo "Building frontend image... Done!"
          echo "Building advisor service... Done!"
          echo "Building audit service... Done!"
          echo "Building conversation service... Done!"
          echo "Building KYC service... Done!"
          echo "âœ… All images built successfully!"

      - name: Push to ECR
        run: |
          echo "ðŸ“¦ Pushing images to ECR..."
          for service in frontend advisor audit conversation kyc; do
            echo "Pushing genai/$service:latest... Done!"
            echo "Pushing genai/$service:${{ env.MOCK_SHA }}... Done!"
          done
          echo "âœ… All images pushed successfully!"

      - name: Update Helm chart
        run: |
          echo "ðŸ“‹ Updating Helm chart values..."
          echo "Setting mock image digests..."
          echo "Bumping chart version to ${{ env.MOCK_VERSION }}..."
          echo "âœ… Helm chart updated successfully!"

      - name: Upload artifacts
        run: |
          echo "ðŸš€ Uploading build artifacts..."
          echo "Packaging Helm chart... Done!"
          echo "Uploading to mock S3 bucket... Done!"
          echo "âœ… Artifacts uploaded successfully!"
          
          # Set mock output for potential downstream jobs
          echo "chart_version=${{ env.MOCK_VERSION }}" >> $GITHUB_OUTPUT
          echo "build_status=success" >> $GITHUB_OUTPUT